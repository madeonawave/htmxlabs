<!-- Drag and Drop Sorting Example with HTMX and JS -->

<div class="box" style="position: relative;">
    <!-- Copy button in top right -->
    <div style="position: absolute; top: 1rem; right: 1rem;">
        <button type="button"
                class="button is-small is-light btn-clipboard"
                title="Copy to clipboard"
                onclick="copyClipboardContent(this)">
            <span class="icon is-small"><i class="fas fa-copy"></i></span>
            <span>Copy</span>
        </button>
    </div>

    <h3 class="title is-4 mb-3">Drag and Drop Sorting</h3>
    <p>
        Drag and drop the items below to reorder them. The new order is sent to the server via HTMX.
    </p>
    <ul id="sortable-list" class="box" style="list-style:none; padding:0;">
        <li class="draggable-item" draggable="true" data-id="1">
            <span class="icon"><i class="fas fa-grip-vertical"></i></span> Item 1
        </li>
        <li class="draggable-item" draggable="true" data-id="2">
            <span class="icon"><i class="fas fa-grip-vertical"></i></span> Item 2
        </li>
        <li class="draggable-item" draggable="true" data-id="3">
            <span class="icon"><i class="fas fa-grip-vertical"></i></span> Item 3
        </li>
        <li class="draggable-item" draggable="true" data-id="4">
            <span class="icon"><i class="fas fa-grip-vertical"></i></span> Item 4
        </li>
    </ul>
    <div id="drag-drop-result" class="mt-3"></div>
</div>
<script>
(function() {
    var list = document.getElementById('sortable-list');
    var draggingEl = null;
    var placeholder = document.createElement('li');
    placeholder.className = 'draggable-item';
    placeholder.style.background = '#f0f0f0';
    placeholder.style.border = '1px dashed #aaa';
    placeholder.style.height = '2.5em';

    list.addEventListener('dragstart', function(e) {
        draggingEl = e.target;
        e.dataTransfer.effectAllowed = 'move';
        setTimeout(function() {
            draggingEl.style.display = 'none';
        }, 0);
    });

    list.addEventListener('dragend', function(e) {
        if (draggingEl) draggingEl.style.display = '';
        draggingEl = null;
        if (placeholder.parentNode) placeholder.parentNode.removeChild(placeholder);
    });

    list.addEventListener('dragover', function(e) {
        e.preventDefault();
        var target = e.target.closest('.draggable-item');
        if (!target || target === draggingEl) return;
        var rect = target.getBoundingClientRect();
        var next = (e.clientY - rect.top) > (rect.height / 2);
        list.insertBefore(placeholder, next ? target.nextSibling : target);
    });

    list.addEventListener('drop', function(e) {
        e.preventDefault();
        if (placeholder.parentNode) {
            list.insertBefore(draggingEl, placeholder);
            placeholder.parentNode.removeChild(placeholder);
        }
        // Send new order to server via HTMX
        var order = Array.from(list.querySelectorAll('.draggable-item')).map(function(li) {
            return li.getAttribute('data-id');
        });
        // Use a hidden form and trigger htmx with JSON encoding
        var form = document.createElement('form');
        form.style.display = 'none';
        form.setAttribute('hx-post', '/demo/drag-drop-update');
        form.setAttribute('hx-target', '#drag-drop-result');
        form.setAttribute('hx-swap', 'innerHTML');
        form.setAttribute('hx-vals', JSON.stringify({'params':{"order": order}}));
        document.body.appendChild(form);

        htmx.process(form);
        htmx.trigger(form, 'submit');
        setTimeout(function() {
            document.body.removeChild(form);
        }, 1000);
    });

    // Add hx attributes to each draggable item for clarity (optional, for demo)
    Array.from(list.querySelectorAll('.draggable-item')).forEach(function(li) {
        li.setAttribute('hx-post', '/demo/drag-drop-update');
        li.setAttribute('hx-target', '#drag-drop-result');
        li.setAttribute('hx-swap', 'innerHTML');
    });
})();
</script>